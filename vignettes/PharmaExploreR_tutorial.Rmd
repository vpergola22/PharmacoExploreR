---
title: "PharmaExploreR dataset workflow tutorial"
author: "Victoria Pergola"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PharmaExploreR dataset workflow tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = FALSE,
  warning = FALSE,
  error = FALSE,
  fig.width = 7,
  fig.height = 5
)

library(PharmacoExploreR)
library(PharmacoGx)
```

## Introduction

### What is PharmacoExploreR?

PharmacoExploreR is an R package that is designed to simply the exploratory 
analysis of pharmacogenomic data. Pharmacogenomics combines molecular profiling 
data with drug response measurements with the goal of identifying biomarkers of 
drug sensitivity. Building off of the PharmacoGx package, this package aims to
make working with **PharmacoSet** objects (standardized objects for storing 
pharmacogenomic data) easier by allowing users to extract meaningful insights
and create figures.

PharmacoExploreR provides:

- **User-friendly functions** for common analytical workflows
- **Correlation analysis** between gene expression and drug response
- **Sample classification** into sensitive and resistant groups
- **High-quality visualizations** including volcano plots, scatterplots, 
boxplots, and dose-response curves
- **Streamlined workflows** for hypothesis generation


### What are PharmacoSets?

A **PharmacoSet** (PSet) is a standardized R object created by the PharmacoGx 
package that contains:

- **Molecular profiling data**: Gene expression, mutations, copy number 
variations
- **Drug sensitivity data**: Measurements like Area Under the Curve (AUC) or 
IC50 values
- **Sample metadata**: Information about cell lines or patient samples
- **Drug metadata**: Information about therapeutic compounds tested


### Key Terminology:

- **AUC (Area Under the Curve)**: A measure of drug sensitivity. Lower AUC 
values indicate greater sensitivity to the drug.
- **AAC (Area Above the Curve)**: The inverse of AUC. Higher AAC values indicate 
greater sensitivity.
- **IC50**: The drug concentration required to inhibit cell growth by 50%.
- **Correlation Analysis**: Statistical method to identify genes whose 
expression levels are associated with drug response.


## 1: Loading a PharmacoSet 

### Option 1: Using the Mini Dataset (Recommended for Tutorial)

For this tutorial, we will use a smaller subset of the NCI60 dataset that 
includes 150 cell lines and 10 drugs. This mini dataset 
allows for faster computation and is ideal for learning the package workflow.

```{r load mini}
# Load the mini NCI60 dataset included with the tutorial
pset <- readRDS(system.file("extdata", "nci60_mini.rds", package = "PharmacoExploreR"))
```

### Option 2: Downloading Full Datasets from PharmacoGx

For full-scale analyses, you can download complete PharmacoSets directly from 
PharmacoGx. These datasets contain hundreds of cell lines and compounds but 
require more time to download and process.

```{r load full, eval=FALSE}
# Load full NCI60 dataset from PharmacoGx
# Note: This is a large file (~314 MB) and may take several minutes to download
library(PharmacoGx)
pset <- downloadPSet("NCI60_2021")

# Alternative: Load other available datasets
# pset <- downloadPSet("GDSC_2020(v1-8.2)")
# pset <- downloadPSet("CTRPv2_2015")

# View all available PharmacoSets
availablePSets()
```


## 2. Inspecting the PharmacoSet Structure

- `@molecularProfiles`: Gene expression and other molecular data
- `@treatmentResponse`: Drug sensitivity measurements
- `@sample`: Cell line metadata
- `@treatment`: Drug metadata


```{r}
# Inspect the PSet to understand what is available
slotNames(pset)

# Look at the names of molecular profiles
names(pset@molecularProfiles)

# Examine the treatment response structure
names(pset@treatmentResponse)

# See the type of each component without printing all the data
lapply(pset@treatmentResponse, function(x) class(x))

# Example: check the first few entries of raw sensitivity data
head(pset@treatmentResponse$raw[, , "Viability"], 3)

# Example: get available molecular data types
names(pset@molecularProfiles)

# Example: get available sensitivity measures
names(pset@treatmentResponse$profiles)

```

Here we observe the raw data containing dose-response measurements.
Each row represents a cell line while each column is a drug and values represent
the cell viability at a particular drug concentration.

```{r}
# List available drugs and cell lines
# cat("Number of drugs:", length(drugNames(pset)), "\n")
# Number of drugs: 10

# cat("Number of cell lines:", length(cellNames(pset)), "\n")
# Number of cell lines: 150

# First 5 drugs:
head(drugNames(pset), 5)

# First 10 cell lines:
head(cellNames(pset), 10)
```

These commands allow us to identify which drugs and cell lines are available in
the dataset, helping us to choose appropriate drugs for our analysis.


## 3: Correlating Gene Expression with Drug Response

Now we can identify specific genes whose expresion levels are associated with
drug sensitivity using the **correlateExpressionAUC()** function. This function
extracts gene expression data for all genes as well as drug sensitivity data 
(AAC) for the specified drug. Then it is able to compute Pearson correlation
between each gene's expression and drug sensitivity across all cell lines, and 
calculate p-values to assess statistical significance. These p-values are also
adjusted for multiple testing using FDR (False Discovery Rate).


```{r}
drug <- "Erlotinib"
res <- correlateExpressionAUC(pset, mDataType = "rna", sensitivity.measure = "aac_recomputed", drug = drug)

# View top results
head(res)
```

## 4: Vizualizing Gene-Drug Relationships with Scatterplots

Now let's visualize the relationship between a specific gene's expression and
drug response using **plotExprAUC()**. This function extracts the expression 
values for the specified gene across all cell lines and the AAC values for the 
specified drug across the same cell lines. It then creates a scatterplot showing
the relationship with a regression line to visualize the trend, and displays 
correlation coefficient and p-value on the plot.

```{r, fig.cap="This scatterplot shows the relationship between expression of the selected gene and the AAC values for Erlotinib across all cell lines. Each point represents a cell line, with gene expression on the x-axis and drug sensitivity on the y-axis (higher AAC = greater sensitivity). The regression line and accompanying correlation coefficient provide a visual summary of whether gene expression is positively or negatively associated with drug response."}
# Select the most highly correlated gene
gene_of_interest <- res$gene[which.max(abs(res$cor))]
drug_of_interest <- "Erlotinib"

scatter_plot <- plotExprAUC(
  pset = pset,
  corResults = res,
  gene = gene_of_interest,
  mDataType = "rna",
  sensitivity.measure = "aac_recomputed",
  drug = drug_of_interest,
  method = "pearson"
)

print(scatter_plot)
```

## 5: Creating a Volcano Plot for Genome-Wide Overview
A volcano plot provides us with an overview of all gene-drug correlations at the
same time. We will use **volcanoAUC** to plot the correlation strength (x-axis)
against the statistical significance (y-axis), highlighting genes that pass both
correlation and significance thresholds.


```{r, fig.cap="This volcano plot provides a genome-wide overview of gene expression correlations with Erlotinib AAC. Each point represents a gene, plotted by correlation strength (x-axis) and −log10(p-value) (y-axis). Genes that pass the specified significance and correlation thresholds are highlighted, helping identify candidate biomarkers that show both strong association and statistical significance."}
# Volcano plot using the results from correlateExpressionAUC
volcano_plot <- volcanoAUC(
  corResults = res,
  corThreshold = 0.3,
  pvalThreshold = 0.05
)

print(volcano_plot)
```

## 6: Classifying Samples into Response Groups

For our analysis we may also want to classify cells into "sensitive" and 
"resistant" groups, which we accomplish using **defineResponseGroups()**. This 
function allows us to use multiple methods (demonstrated below) to split cell
lines into the appropriate category.


```{r}
# Using median split
response_groups <- defineResponseGroups(pset, drug_of_interest, sensitivity.measure = "aac_recomputed", method = "median")
table(response_groups)

# Using quantiles (bottom 25% sensitive, top 25% resistant)
response_groups_q <- defineResponseGroups(pset, drug_of_interest, sensitivity.measure = "aac_recomputed", method = "quantile")
table(response_groups_q)

# Using manual threshold
response_groups_manual <- defineResponseGroups(pset, drug_of_interest, sensitivity.measure = "aac_recomputed", method = "manual", threshold = 0.6)
table(response_groups_manual)
```

## 7: Differential Expression Analysis
Now we can identify any genes that are differentially expressed between
sensitive and resistant cell lines using the **runDiffExpr()** function.


```{r}
# Define groups
response_groups <- defineResponseGroups(pset, drug_of_interest, sensitivity.measure = "aac_recomputed", method = "median")

# Run differential expression
diff_expr_res <- runDiffExpr(pset, groupLabels = response_groups, mDataType = "rna", method = "t.test")

# Inspect top genes
head(diff_expr_res[order(diff_expr_res$adj_pval), ])
```


## 8: Visualizing Gene Expression by Response Group
This package has multiple useful functions for visualizing how a specific gene's
expression differs between sensitive and resistant groups. Here we use 
**plotGeneBoxplot()** to create boxplots as well as violin plots to observe
these relationships.


```{r, fig.cap="This boxplot compares the expression of the selected gene between cell lines classified as sensitive or resistant to Erlotinib using median-based grouping. The plot displays median expression, variability, and outliers, allowing users to visually assess whether gene expression differs meaningfully between response groups."}
# Assume response_groups was created with defineResponseGroups()

# Boxplot
p1 <- plotGeneBoxplot(pset, gene_of_interest, response_groups, mDataType = "rna", plotType = "boxplot")
print(p1)
```

```{r, fig.cap="This violin plot provides a visualization of the distribution of gene expression for the same sensitive and resistant groups, combining density information with summary statistics. The shape reveals distributional differences that may not be apparent in boxplots alone, such as multimodality or skew."}
# Violin plot
p2 <- plotGeneBoxplot(pset, gene_of_interest, response_groups, mDataType = "rna", plotType = "violin")
print(p2)
```


## 9: Plotting Dose-Response Curves

Finally, we want to visualize the actual dose-response relationships for
specific cell lines using **plotDoseResponse()**. This function extracts raw 
dose-response data for the specified cell lines and drug, plotting cell 
viability (y-axis) against drug concentration (x-axis). Each curve represents 
one cell line, showing how cell viability decreases as drug 
concentration increases.

```{r, fig.width=9, fig.cap="These dose–response curves show how cell viability changes with increasing concentrations of Erlotinib for three selected cell lines. Each curve represents one cell line, with drug concentration on the x-axis and viability on the y-axis. This visualization highlights differences in drug sensitivity and allows users to qualitatively compare response profiles across samples."}
# Pick 3 valid cell lines from the available ones
validCellLines <- rownames(pset@treatmentResponse$raw[, , "Viability"])
cellLines <- validCellLines[1:3]

# Plot dose-response curves
plotDoseResponse(pset, cell.lines = cellLines)
```


## Session Information
```{r}
sessionInfo()
```


## References

Smirnov, P., Safikhani, Z., El-Hachem, N., Wang, D., She, A., Olsen, C., Freeman, M., Selby, H., Gendoo, D. M., Grossman, P., Beck, A. H., Aerts, H. J., Lupien, M., Goldenberg, A., & Haibe-Kains, B. (2016). PharmacoGx: an R package for analysis of large pharmacogenomic datasets. *Bioinformatics*, 32(8), 1244-1246.

Geeleher, P., Cox, N., & Huang, R. S. (2014). pRRophetic: an R package for prediction of clinical chemotherapeutic response from tumor gene expression levels. *PloS one*, 9(9), e107468.
